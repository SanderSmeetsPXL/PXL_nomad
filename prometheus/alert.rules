---
groups:
  - name: Prometheus rules
    rules:
      - alert: PrometheusJobMissing
        expr: absent(up{job="prometheus"})
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: Prometheus job missing (instance {{ $labels.instance }})
          description: A Prometheus job has disappeared\n  VALUE = {{ $value }}\n  LABELS:  {{ $labels }}

      - alert: PrometheusTargetMissing
        expr: up == 0
        for: 0m
        labels:
            severity: critical
        annotations:
            summary: Prometheus target missing (instance {{ $labels.instance }})
            description: A Prometheus target has disappeared. An exporter might be crashed.\n  VALUE = {{ $value }}\n  LABELS:  {{ $labels }}

      - alert: PrometheusTooManyRestarts
        expr: changes(process_start_time_seconds{job=~"prometheus|pushgateway|alertmanager"}[15m]) > 2
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: Prometheus too many restarts (instance {{ $labels.instance }})
          description: Prometheus has restarted more than twice in the last 15 minutes. It might be crashlooping.\n  VALUE = {{ $value }}\n  LABELS:  {{ $labels }}

      - alert: PrometheusAlertmanagerConfigurationReloadFailure
        expr: alertmanager_config_last_reload_successful != 1
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: Prometheus AlertManager configuration reload failure (instance {{ $labels.instance }})
          description: AlertManager configuration reload error\n  VALUE = {{ $value }}\n  LABELS:  {{ $labels }}  

      - alert: PrometheusNotConnectedToAlertmanager
        expr: prometheus_notifications_alertmanagers_discovered < 1
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: Prometheus not connected to alertmanager (instance {{ $labels.instance }})
          description: Prometheus cannot connect the alertmanager\n  VALUE = {{ $value }}\n  LABELS:  {{ $labels }}   

      - alert: HostOutOfMemory
        expr: node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes * 100 < 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: Host out of memory (instance {{ $labels.instance }})
          description: Node memory is filling up (< 10% left)\n  VALUE = {{ $value }}\n  LABELS:  {{ $labels }}      
      
      - alert: HostOutOfDiskSpace
        expr: (node_filesystem_avail_bytes * 100) / node_filesystem_size_bytes < 10 and ON (instance, device, mountpoint) node_filesystem_readonly == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: Host out of disk space (instance {{ $labels.instance }})
          description: Disk is almost full (< 10% left)\n  VALUE = {{ $value }}\n  LABELS:  {{ $labels }}

      - alert: RedisDown
        expr: redis_up == 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: Redis down (instance {{ $labels.instance }})
          description: Redis instance is down\n  VALUE = {{ $value }}\n  LABELS:  {{ $labels }}

      - alert: NomadJobFailed
        expr: nomad_nomad_job_summary_failed > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: Nomad job failed (instance {{ $labels.instance }})
          description: Nomad job failed\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}      

       - alert: NomadJobLost
        expr: nomad_nomad_job_summary_lost > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: Nomad job lost (instance {{ $labels.instance }})
          description: Nomad job lost\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}    

       - alert: ConsulServiceHealthcheckFailed
        expr: consul_catalog_service_node_healthy == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: Consul service healthcheck failed (instance {{ $labels.instance }})
          description: Service: `{{ $labels.service_name }}` Healthcheck: `{{ $labels.service_id }}`\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}  